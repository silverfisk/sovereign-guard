<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sovereign Guard – Architecture & Implementation (ESP-IDF/Arduino)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    :root{--ink:#0f172a;--muted:#475569;--surf:#f8fafc;--blue:#1d4ed8;--green:#059669;--amber:#b45309}
    body{font-family:'Inter',sans-serif;color:var(--ink);background:#fff}
    .mono{font-family:'JetBrains Mono',monospace}
    .wrap{max-width:960px;margin:0 auto;padding:2rem 1.25rem}
    .h{font-weight:800}
    .card{background:var(--surf);border:1px solid #e2e8f0;border-radius:12px;padding:1rem 1.25rem}
    .k{color:var(--blue);font-weight:700}
    .pill{border:1px solid #e2e8f0;border-radius:999px;padding:.25rem .6rem;background:#fff}
    pre{background:#0f172a;color:#e5e7eb;padding:1rem;border-radius:10px;overflow:auto}
    code{font-family:'JetBrains Mono',monospace}
    .grid2{display:grid;gap:1rem;grid-template-columns:1fr 1fr}
    @media(max-width:900px){.grid2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="flex items-center gap-2 mb-2">
      <span class="pill mono text-sm">ESP32-CAM</span>
      <span class="pill mono text-sm">ESP-IDF/Arduino</span>
      <span class="pill mono text-sm">USB serial</span>
    </div>
    <h1 class="text-4xl h mb-2">Sovereign Guard – Architecture & Implementation</h1>
    <h2 class="text-2xl h mt-8 mb-2">Executive Summary</h2>
    <div class="card">
      <ul class="mono text-[15px] text-[var(--muted)] space-y-2">
        <li>• Device firmware in <b>ESP-IDF/Arduino</b>.</li>
        <li>• ESP32-CAM USB is UART-only → <b>no USB HID</b>. BLE HID optional.</li>
        <li>• No discrete secure element on classic ESP32. Roadmap: Secure Boot + Flash Encryption or external SE.</li>
        <li>• Device owns policy & escalation; agent is data source + friendly actor.</li>
      </ul>
    </div>

    <h2 class="text-2xl h mt-8 mb-2">System Architecture</h2>
    <div class="grid2">
      <div class="card">
        <h3 class="h mb-2 k">ESP32 Device</h3>
        <ul class="mono text-[15px] text-[var(--muted)] space-y-1">
          <li>• UART 115200, line-delimited JSON (cJSON/ArduinoJson)</li>
          <li>• Relay driver, watchdog state machine with backoff & lockout</li>
          <li>• Optional SD audit log</li>
          <li>• Roadmap: Secure Boot + Flash Encryption (IDF)</li>
        </ul>
      </div>
      <div class="card">
        <h3 class="h mb-2 k">Server Daemon (Python)</h3>
        <ul class="mono text-[15px] text-[var(--muted)] space-y-1">
          <li>• pyserial for USB; psutil for metrics; optional FastAPI dashboard</li>
          <li>• Whitelist of restartable services</li>
          <li>• Optional verification of pre‑signed command bundles (GPG/Ed25519)</li>
        </ul>
      </div>
    </div>

    <h2 class="text-2xl h mt-8 mb-2">Escalation Ladder & Protocol</h2>
    <p class="mono text-[15px] text-[var(--muted)]">The device is authoritative. It requests soft actions first, then escalates.</p>

<pre><code># Agent → Device heartbeat (every 10 s)
{"t":"hb","ts":1699999999,"cpu":0.42,"load1":1.8,"svc_ok":true}

# Device → Agent requests
{"t":"request","req_id":"b8e1","action":"restart_service","service":"myapp.service",
 "reason":"svc_unhealthy","deadline_ms":30000}

{"t":"request","req_id":"aa77","action":"reboot_os","reason":"degraded_persist","deadline_ms":90000}

# Agent → Device replies
{"t":"ack","req_id":"b8e1","status":"executing"}
{"t":"done","req_id":"b8e1","ok":true,"msg":"systemctl restart done"}
</code></pre>

    <h2 class="text-2xl h mt-8 mb-2">Security Model</h2>
    <div class="card">
      <ul class="mono text-[15px] text-[var(--muted)] space-y-2">
        <li>• MVP: keys in flash; protect physical access; log all actions.</li>
        <li>• Production path: ESP-IDF <b>Secure Boot + Flash Encryption</b>.</li>
        <li>• Option: External secure element (ATECC608A) via I²C.</li>
        <li>• Anti‑replay: add nonces and timestamps to request/response; optional Ed25519/HMAC.</li>
      </ul>
    </div>

    <h2 class="text-2xl h mt-8 mb-2">Implementation Plan</h2>
    <ol class="mono text-[15px] text-[var(--muted)] space-y-2">
      <li>1) Firmware skeleton (UART, JSON, state machine, relay GPIO)</li>
      <li>2) Python agent (pyserial + psutil heartbeat; request handler for restart/reboot)</li>
      <li>3) Stability tests (grace windows, backoff, lockout)</li>
      <li>4) Optional BLE HID module; optional SD audit log</li>
      <li>5) Roadmap hardening (Secure Boot/Flash Encryption)</li>
    </ol>

    <h2 class="text-2xl h mt-8 mb-2">USB/HID Notes</h2>
    <p class="mono text-[15px] text-[var(--muted)]">
      ESP32‑CAM exposes only USB‑UART via its onboard bridge; it cannot present as a USB HID keyboard.
      For composite USB (CDC + HID), use ESP32‑S2/S3 or RP2040 in a subsequent hardware revision.
    </p>
  </div>
</body>
</html>
